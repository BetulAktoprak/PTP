
@{
    ViewData["Title"] = "ManageProcesses";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/jkanban@1.3.1/dist/jkanban.min.css" rel="stylesheet">
<script src="https://unpkg.com/jkanban@1.3.1/dist/jkanban.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<select id="projectSelect" class="form-select mb-3">
    <option selected disabled>Bir proje seçin...</option>
</select>

<hr />
<div class="row" id="processBoard" style="min-height: 400px;">
    <div class="col">
        <h5>To Do</h5>
        <div class="bg-light p-2 rounded drop-column" id="todoColumn"></div>
    </div>
    <div class="col">
        <h5>In Progress</h5>
        <div class="bg-light p-2 rounded drop-column" id="inProgressColumn"></div>
    </div>
    <div class="col">
        <h5>Done</h5>
        <div class="bg-light p-2 rounded drop-column" id="doneColumn"></div>
    </div>
</div>

<script>
        $(document).ready(function () {
        // Projeleri dropdown'a yükle
        $.get('/Admin/GetAllProjects', function (data) {
            data.forEach(function (project) {
                $('#projectSelect').append(`<option value="${project.id}">${project.name}</option>`);
            });
        });

        // Proje seçildiğinde işlemleri yükle
        $('#projectSelect').change(function () {
            const projectId = $(this).val();
            $.get(`/Admin/GetAllByProjectId/${projectId}`, function (processes) {
                $('#todoColumn, #inProgressColumn, #doneColumn').empty();
                processes.forEach(function (p) {
                    const card = `<div draggable="true" ondragstart="drag(event)" id="process-${p.id}" class="card mb-2 shadow-sm">
                        <div class="card-body p-2">
                            <strong>${p.title}</strong><br/>
                            <small>${p.description}</small>
                        </div>
                    </div>`;
                    if (p.processType === "ToDo") $('#todoColumn').append(card);
                    else if (p.processType === "InProgress") $('#inProgressColumn').append(card);
                    else $('#doneColumn').append(card);
                });
            });
        });

        document.querySelectorAll('.drop-column').forEach(column => {
            column.addEventListener('dragover', function (e) {
                e.preventDefault();
            });

            column.addEventListener('drop', function (e) {
                e.preventDefault();
                const data = e.dataTransfer.getData("text");
                const card = document.getElementById(data);
                column.appendChild(card);

                const processId = data.split('-')[1];
                const newType = getColumnType(column.id);

                $.ajax({
                    url: `/Admin/UpdateType`,
                    type: 'POST',
                    data: JSON.stringify({ id: processId, newType: newType }),
                    contentType: 'application/json',
                    success: function () {
                        console.log("Güncelleme başarılı.");
                    },
                    error: function () {
                        alert("Bir hata oluştu.");
                    }
                });
            });
        });
    });



</script>

